<!DOCTYPE html>
<html class="page-index">
	<head>
		<meta charset="UTF-8" />
		<link rel="stylesheet" type="text/css" href="players/videojs/video-js.min.css" />
		<link rel="stylesheet" type="text/css" href="players/videojs/videojs-dvrseekbar.css" />
		<link rel="stylesheet" type="text/css" href="players/videojs/videojs-stop-button.css" />
		<link rel="stylesheet" type="text/css" href="assets/css/player.css" />
		<style type="text/css">	
			* {
				-webkit-user-drag: none;
			}
			body {
				margin: 0;
			}		
			.video-js {
				width: 100vw !important;
    			height: 100vh !important;
			}
			.vjs-progress-holder {
				max-width: 100%;
			}
			.vjs-icon-square:before {
    			font-size: large;
			}
			video {
				object-fit: fill;
			}
		</style>
	</head>
	<body>
		<script type="text/javascript" src="assets/js/jquery-3.2.1.js"></script>
		<script type="text/javascript" src="assets/js/jquery.shortcuts.min.js"></script>
		<script type="text/javascript" src="assets/js/global.js"></script>
		<script type="text/javascript" src="players/videojs/video.min.js"></script>
		<script type="text/javascript" src="players/videojs/videojs-contrib-hlsjs.min.js"></script>
		<script type="text/javascript" src="players/videojs/videojs-dvrseekbar.min.js"></script>
		<script type="text/javascript" src="players/videojs/videojs-stop-button.js"></script>
		<script type="text/javascript">
			var lastPlaybackData, video, v, player, _paused = false, lastCurrentTime = 0, stopEvent = function(e) {
				if(e){
					e.stopPropagation();
					e.preventDefault();
				}
				return false;
			};
			function src(_src, type){
				player.off('error');
				lastPlaybackData = {src: _src, type: type};
				player.src(lastPlaybackData);
				player.load()
			}
			function pause(){
				if(!paused()){
					player.pause()
				}
			}
			function unpause(){
				if(paused()){
					player.play()
				}
			}
			function paused(){
				return player.paused()
			}
			function stop(){
				player.off('error');
				player.pause();
				player.reset()
			}
			function videoElement(){
				if(!video || !video.parentNode){
					reset()
				}
				return video;
			}
			function play(callback){
				//if(lastPlaybackData){
				//	player.src(lastPlaybackData);
				//	player.load();
				//}
				console.log('player.play()')
				player.ready(() => {
					player.play();
					if(typeof(callback)=='function'){
						callback()
					}
				})
			}
			function currentTime(s){
				if(s){
					player.currentTime(s)
				}
				return player.currentTime()
			}
			function seek(s){
				var t = player.currentTime();
				player.currentTime(t + s)
			}
			function patchVideo(v){
				v.off('mousedown click mouseup');
				v.on('mousedown', function(event) {
					_paused = !video.paused;
					console.log('Player.PAUSED = ' + JSON.stringify(_paused));
					return stopEvent(event);
				})
				v.on('click', function(event) {
					return stopEvent(event);
				})
				v.on('mouseup', function(event) {
					setTimeout(() => {
						if (_paused) {
							console.log('Player.PLAY');
							top.PlaybackManager.play()
						}
						else {
							console.log('Player.PAUSE');
							top.PlaybackManager.pause()
						}
					}, 0);
					return stopEvent(event);
				})
				var playPauseDelayTimer;
				player.off('play');
				player.off('pause');
				player.off('error');
				player.on('play', function(event) {
					clearTimeout(playPauseDelayTimer);
					top.delayedPlayPauseNotify()
				});
				player.on('pause', function(event) {
					clearTimeout(playPauseDelayTimer);
					playPauseDelayTimer = setTimeout(function (){ // delay a bit to avoid the pause UI on seeking
						if(player.paused() && top){
							top.delayedPlayPauseNotify();
						}
					}, 500)
				});
				player.on('error', function(event) {
					//top.PlaybackManager.activeIntent.error = true;
					//top.PlaybackManager.activeIntent.trigger('error');
					console.log('Video.JS error', event)
				})
			}
			function reset(){
				var ct = 0;
				if(player){
					ct = player.currentTime()
				}
				jQuery('video, .video-js').remove();
				if(player){
					player.dispose()
				}
				delete window['player'];
				video = document.createElement('video');
				v = jQuery(video);
				document.querySelector('body').appendChild(video);
				video.className = 'video-js'; // set here to skip auto-setup
				player = videojs(video, { 
					"controls": true, 
					"autoplay": true, 
					"preload": "auto" 
				});
				player.dvrseekbar(); // re-enable when the slider gets fixed, maybe the ondragstart hook at global.js or helper.js
				player.stopButton();
				if(lastPlaybackData){
					player.src(lastPlaybackData);
					player.load();
					if(ct){
						player.ready(() => {
							player.currentTime(ct)
						})
					}
				}
				patchVideo(v)
			}
			reset();
			jQuery('.video-js').on('mousedown', '.vjs-fullscreen-control', function (e){ // .live()
				top.toggleFullScreen();
				e.stopPropagation();
				e.preventDefault();
				return false;
			});
			jQuery('.video-js').on('mousedown', '.vjs-stop-button', function (e){ // .live()
				top.stop();
				e.stopPropagation();
				e.preventDefault();
				return false;
			});
			jQuery(() => {
				setTimeout(() => {
					top.createMouseObserverForControls(window)				
				}, 200)
			})
		</script>
	</body>
</html>
